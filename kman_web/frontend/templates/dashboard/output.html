{% extends "base.html" %}
{% block content %} 
<div class = "panel-group" id="accordion">
    <div class="panel panel-default" style="width=100%" id ="panel0">
        <div class="panel-heading">
        <strong>Job status: </strong><span class="label label-default" id="status">QUEUED</span>
        </div>
    </div>
    <div class="panel panel-default" style="width=100%" id="panel1">
      <div class="panel-heading">
        <h4 class="panel-title">
          <span class="panel_title_text">Disorder prediction</span>
        </h4>
      </div>
      <div id = "collapseOne" class = "panel-collapse collapse">
        <div class="panel-body">
          <div id="canvas" style="overflow:auto; height:auto; width:100%;">
          </div>
          <div id="output">
          </div>
        </div>
      </div>
      <div class=panel-footer>
        <div id="download">
            <form action="{{ url_for("dashboard.download") }}" method=POST style="clear:both;" >
                  <input type="hidden" id="download_pred_input" name="prediction"  style="display:none;"/>
                  <button type="submit" id="download_pred_button" class="btn btn-primary btn-xs disabled" style="float:right;" value="Submit">
                      <span class="glyphicon glyphicon-save"></span> Download
                  </button>
            </form>
            <div class="clearfix"></div>
        </div>
      </div>
    </div>
    <div class="panel panel-default" style="width=100%;" id="panel2">
      <div class="panel-heading">
          <h4 class="panel-title">
              <span class="panel_title_text">Alignment</span>
              </a>
          </h4>
      </div>
      <div id="collapseTwo" class = "panel-collapse collapse">
        <div class="panel-body">
          <span class="panel_body_text">
            <strong>coloring mode:&#160;&#160;&#160;&#160;</strong>
            <button type="submit" id="regular_mode_button" class="btn btn-regular
              btn-xs disabled" onclick="changeModeRegular()">
              <strong>Regular</strong>
            </button>
            <button type="submit" id="ptm_mode_button" class="btn btn-ptms
              btn-xs" onclick="changeModePTMS()">
              <strong>PTMs</strong>
            </button>
            <button type="submit" id="motif_mode_button" class="btn btn-motifs
              btn-xs" onclick="changeModeMotifs()">
              <strong>Motifs</strong>
            </button>
            <button type="submit" id="domain_mode_button" class="btn btn-domains
              btn-xs" onclick="changeModeDomains()">
              <strong>Domains</strong>
            </button>
          
          </span>
          <br>
          <br>
            <pre>
              <div id="canvases" style="position:relative; height:auto; width:100%;">
                <div id="alignment_canvas" style="position:absolute; left:0px;
                  top:0px; overflow:auto; height:auto; width:100%;">
                </div>
                <div id="alignment_canvas_ptms" style="position:absolute;
                  left:0px; top:0px; overflow:auto;
                  height:auto; width:100%; display:none;">
                </div>
                <div id="alignment_canvas_motifs" style="position:absolute;
                  left:0px; top:0px;
                  overflow:auto;
                  height:auto; width:100%; display:none;">
                </div>
                <div id="alignment_canvas_domains" style="position:absolute;
                  left:0px; top:0px; overflow:auto;
                  height:auto; width:100%; display:none;">
                </div>
              </div>
            </pre>
          <br>
          <span class="panel_title_text">Color legend</span>
          <br>
          <pre>
              <div id="legend_canvas" style="overflow:auto; height:auto; width:100%;">
              </div>
              <div id="legend_canvas_ptms" style="overflow:auto;
                height:auto; width:100%; display:none;">
              </div>
              <div id="legend_canvas_motifs" style="overflow:auto;
                height:auto; width:100%; display:none;">
              </div>
              <div id="legend_canvas_domains" style="overflow:auto;
                height:auto; width:100%; display:none;">
              </div>
          </pre>
          </div>
      </div>
      <div class=panel-footer>
        <div id="download_alignment">
            <form action="{{ url_for("dashboard.download_alignment") }}" method=POST style="clear:both;" >
             <input type="hidden" id="download_al_input" name="alignment" style="display:none;"/>
             <button type="submit" id="download_al_button" class="btn btn-primary btn-xs disabled" style="float:right;" value="Submit">
                 <span class="glyphicon glyphicon-save"></span> Download
             </button>
            </form>
            <div class="clearfix"></div>
        </div>
      </div>
   </div>                
</div>
{% endblock %}


{% block js %}
<script type="text/javascript">
  
  if ("{{ output_type }}" == 'predict'){
     document.getElementById('panel2').style.display = 'none';
     document.getElementById('panel3').style.display = 'none';
  }
  else if ("{{ output_type }}" == 'align'){
     document.getElementById('panel1').style.display = 'none';
  }
  $(document).ready(function() {
    var intervalId = setInterval(function(){
        $.getJSON(
          "{{ url_for('kman.get_kman_status', output_type=output_type, id=celery_id) }}",
          function(data) {
            $('#status').text(data['status']);

            if (data['status'] == 'PENDING') {
              $('#status').removeClass("label-default")
                          .addClass("label-info");
              $('#panel0').removeClass("panel-default")
                          .addClass("panel-info");
            }

            if (data['status'] == 'FAILURE') {
              clearInterval(intervalId);
              $('#status').removeClass("label-default label-info")
                          .addClass("label-danger");
              $('#panel0').removeClass("panel-default panel-info")
                          .addClass("panel-danger");
              $('#output').text(data['message']);
            }

            if (data['status'] == 'SUCCESS') {
              clearInterval(intervalId);
              $('#status').removeClass("label-default label-info")
                          .addClass("label-success");
              $('#panel0').removeClass("panel-default panel-info")
                          .addClass("panel-success");
              $.getJSON(
                  "{{ url_for('kman.get_kman_result', output_type=output_type, id=celery_id) }}",
                  function(data) {
                    if ("{{ output_type }}" != 'align'){
                      var proseq = new ProteinSequences("canvas", data['result']['prediction']);
                      proseq.update()
                      $('#collapseOne').addClass('in');
                      var raw_data = get_text_data(data['result']['prediction']);
                      document.getElementById('download_pred_input').value = raw_data;
                      $('#download_pred_button').removeClass('disabled');
                    }
                    if ("{{ output_type }}" != 'predict'){
                      var raw_alignment = data['result']['alignment']['raw'];
                      document.getElementById('download_al_input').value = raw_alignment;
                      var processed_alignment = data['result']['alignment']['processed'];
                      var encoded_alignment = data['result']['alignment']['encoded'];
                      var alignment = new SequenceAlignment('alignment_canvas', processed_alignment);
                      alignment.update();
                      var codon_length = 7;
                      var alignment_ptms = new SequenceAlignmentPTMs('alignment_canvas_ptms', encoded_alignment, codon_length);
                      alignment_ptms.update();
                      var alignment_motifs = new SequenceAlignmentMotifs('alignment_canvas_motifs', encoded_alignment, codon_length);
                      alignment_motifs.update();
                      var alignment_domains = new SequenceAlignmentDomains('alignment_canvas_domains', encoded_alignment, codon_length);
                      alignment_domains.update();
                      $('#download_al_button').removeClass('disabled');
                      $('#collapseTwo').addClass('in');
                      $('#collapseThree').addClass('in');
                      console.debug("debug check");
                    }
                });
            }
          }
        )}, 1000);
  });
  changeModePTMS = function() {
    document.getElementById('alignment_canvas').style.display = 'none'; 
    document.getElementById('alignment_canvas_domains').style.display = 'none'; 
    document.getElementById('alignment_canvas_motifs').style.display = 'none'; 
    document.getElementById('alignment_canvas_ptms').style.display = ''; 
    $('#ptm_mode_button').addClass('disabled');
    $('#regular_mode_button').removeClass('disabled');
    $('#motif_mode_button').removeClass('disabled');
    $('#domain_mode_button').removeClass('disabled');

  }
  changeModeRegular = function() {
    document.getElementById('alignment_canvas').style.display = ''; 
    document.getElementById('alignment_canvas_domains').style.display = 'none'; 
    document.getElementById('alignment_canvas_motifs').style.display = 'none'; 
    document.getElementById('alignment_canvas_ptms').style.display = 'none'; 
    $('#ptm_mode_button').removeClass('disabled');
    $('#regular_mode_button').addClass('disabled');
    $('#motif_mode_button').removeClass('disabled');
    $('#domain_mode_button').removeClass('disabled');
  }
  changeModeDomains = function() {
    document.getElementById('alignment_canvas').style.display = 'none'; 
    document.getElementById('alignment_canvas_domains').style.display = ''; 
    document.getElementById('alignment_canvas_motifs').style.display = 'none'; 
    document.getElementById('alignment_canvas_ptms').style.display = 'none'; 
    $('#ptm_mode_button').removeClass('disabled');
    $('#regular_mode_button').removeClass('disabled');
    $('#motif_mode_button').removeClass('disabled');
    $('#domain_mode_button').addClass('disabled');
  }
  changeModeMotifs = function() {
    document.getElementById('alignment_canvas').style.display = 'none'; 
    document.getElementById('alignment_canvas_domains').style.display = 'none'; 
    document.getElementById('alignment_canvas_motifs').style.display = ''; 
    document.getElementById('alignment_canvas_ptms').style.display = 'none'; 
    $('#ptm_mode_button').removeClass('disabled');
    $('#regular_mode_button').removeClass('disabled');
    $('#motif_mode_button').addClass('disabled');
    $('#domain_mode_button').removeClass('disabled');
  }
</script>
{% endblock %}
